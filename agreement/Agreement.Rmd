---
title: "Agreement"
author: "João Silva"
date: "2025-12-13"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Reliability and agreement exercises

## Introduction

A table of data agree_1_IA.csv contains information on the classification of the questions (1=yes or 0=no) of 2226 queries.

The classification was made independently by syntax rules (variables: Rules) and by three different LLMs 2 times each (variables: LLM_run1_Perplexity, LLM_run2_Perplexity, LLM_run1_GPT, LLM_run2_GPT, LLM_run1_Gemini, LLM_run2_Gemini).

1. Assess the inter-rater agreement and reliably among classification method.

2. Are the two development tests intersubstitutable?

## Install and load packages: foreignm obs-agree, psy, boot

```{r, results='hide', include= FALSE}
# CRAN packages list
cran_packages <- c("psy", "boot","tidyverse", "ggplot2", "reshape2")

# Install only CRAN packages that are not already installed
for (pkg in cran_packages) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    install.packages(pkg)
  }
}

# Check and install obs.agree if necessary
if (!requireNamespace("obs.agree", quietly = TRUE)) {
  install.packages("obs.agree_1.0.tar", repos = NULL, type = "source")
}

# Load all packages
all_packages <- c(cran_packages, "obs.agree")
lapply(all_packages, library, character.only = TRUE)
```


## Get data from csv file

```{r}
# Read the csv file named "agree_1_IA.csv" using the read.csv function
# After file=, you must enter the path to the agree_1_IA.csv file on your computer.
agree_1_IA <- read.csv(file="agree_1_IA.csv",sep=";",header=TRUE)
agree_1_sample <- read.csv(file="agree_1_sample.csv",sep=";",header=TRUE)
agree_1_sample_manual <- read.csv(file="agree_1_sample_manual.csv",sep=";",header=TRUE)
agree_1_sample_alt <- read.csv(file="agree_1_sample_alt.csv",sep=";",header=TRUE)
agree_2 <- read.csv(file="agree_2.csv",sep=";",header=TRUE)
# Convert the 'agree' object (which is a special 'data.frame' class from read.csv) into a standard R data.frame
# This ensures compatibility with other functions that expect a common data.frame
agree_1_IA <- as.data.frame(agree_1_IA)
agree_1_sample <- as.data.frame(agree_1_sample)
agree_1_sample_manual <- as.data.frame(agree_1_sample_manual)
agree_1_sample_alt <- as.data.frame(agree_1_sample_alt)
agree_2 <- as.data.frame(agree_2)
# Convert the 'agree' data.frame into a data matrix (data.matrix)
# This transforms all columns into numeric types if possible, creating a numeric matrix
# Useful for analyses requiring matrix data, but may lose factor labels or strings
agree_1_IA <- data.matrix(agree_1_IA)
agree_1_sample <- data.matrix(agree_1_sample)
agree_1_sample_manual <- data.matrix(agree_1_sample_manual)
agree_1_sample_alt <- data.matrix(agree_1_sample_alt)
agree_2 <- data.matrix(agree_2)
```

## Part 1: assess the inter-rater agreement and reliability among classifications

### To asssess the agreement: Proportions of overall and specific agreement 

```{r}
RAI_1_sample_IA<-RAI(agree_1_sample[,c(1,2,3,4,5,6,7)])
RAI_1_sample<-RAI(agree_1_sample[,c(1,2,3,4,5,6,7,8,9)])
RAI_1_sample_manual<-RAI(agree_1_sample_manual[,c(1,2)])
RAI_1_sample_alt<-RAI(agree_1_sample_alt[,c(1,2)])
cat("IA Overall agreement")
RAI_1_sample_IA$Overall_agreement$value
cat("Sample Overall agreement")
RAI_1_sample$Overall_agreement$value
cat("Sample Manual Overall agreement")
RAI_1_sample_manual$Overall_agreement$value
cat("IA Specific agreement")
RAI_1_sample_IA$Specific_agreement$value
cat("Sample Specific agreement")
RAI_1_sample$Specific_agreement$value
cat("Sample Manual Specific agreement")
RAI_1_sample_manual$Specific_agreement$value
```

If one IA method, selected at random, makes a classification (particular query present: yes or no), the probability of another method making an equal classification is 0.96

If one IA method, selected at random, makes the classification yes (the particular query is present), the probability of another method making the same classification is 0.98

If one IA method, selected at random, makes the classification no (the particular query is not present), the probability of another method making the same classification is 0.82

### To asssess the agreement: Proportions of overall and specific agreement

```{r}
# Calculate RAI for IA method 1 vs IA method 1
RAI_1_sample_IA_1.1<-RAI(agree_1_sample[,c(1,1)])
# Calculate RAI for IA method 1 vs IA method 2
RAI_1_sample_IA_1.2<-RAI(agree_1_sample[,c(1,2)])
# Calculate RAI for IA method 1 vs IA method 3
RAI_1_sample_IA_1.3<-RAI(agree_1_sample[,c(1,3)])
# Calculate RAI for IA method 1 vs IA method 4
RAI_1_sample_IA_1.4<-RAI(agree_1_sample[,c(1,4)])
# Calculate RAI for IA method 1 vs IA method 5
RAI_1_sample_IA_1.5<-RAI(agree_1_sample[,c(1,5)])
# Calculate RAI for IA method 1 vs IA method 6
RAI_1_sample_IA_1.6<-RAI(agree_1_sample[,c(1,6)])
# Calculate RAI for IA method 1 vs IA method 7
RAI_1_sample_IA_1.7<-RAI(agree_1_sample[,c(1,7)])
# Calculate RAI for IA method 1 vs IA method 8
RAI_1_sample_IA_1.8<-RAI(agree_1_sample[,c(1,8)])
# Calculate RAI for IA method 1 vs IA method 9
RAI_1_sample_IA_1.9<-RAI(agree_1_sample[,c(1,9)])
# Calculate RAI for IA method 2 vs IA method 2
RAI_1_sample_IA_2.2<-RAI(agree_1_sample[,c(2,2)])
# Calculate RAI for IA method 2 vs IA method 3
RAI_1_sample_IA_2.3<-RAI(agree_1_sample[,c(2,3)])
# Calculate RAI for IA method 2 vs IA method 4
RAI_1_sample_IA_2.4<-RAI(agree_1_sample[,c(2,4)])
# Calculate RAI for IA method 2 vs IA method 5
RAI_1_sample_IA_2.5<-RAI(agree_1_sample[,c(2,5)])
# Calculate RAI for IA method 2 vs IA method 6
RAI_1_sample_IA_2.6<-RAI(agree_1_sample[,c(2,6)])
# Calculate RAI for IA method 2 vs IA method 7
RAI_1_sample_IA_2.7<-RAI(agree_1_sample[,c(2,7)])
# Calculate RAI for IA method 2 vs IA method 8
RAI_1_sample_IA_2.8<-RAI(agree_1_sample[,c(2,8)])
# Calculate RAI for IA method 2 vs IA method 9
RAI_1_sample_IA_2.9<-RAI(agree_1_sample[,c(2,9)])
# Calculate RAI for IA method 3 vs IA method 3
RAI_1_sample_IA_3.3<-RAI(agree_1_sample[,c(3,3)])
# Calculate RAI for IA method 3 vs IA method 4
RAI_1_sample_IA_3.4<-RAI(agree_1_sample[,c(3,4)])
# Calculate RAI for IA method 3 vs IA method 5
RAI_1_sample_IA_3.5<-RAI(agree_1_sample[,c(3,5)])
# Calculate RAI for IA method 3 vs IA method 6
RAI_1_sample_IA_3.6<-RAI(agree_1_sample[,c(3,6)])
# Calculate RAI for IA method 3 vs IA method 7
RAI_1_sample_IA_3.7<-RAI(agree_1_sample[,c(3,7)])
# Calculate RAI for IA method 3 vs IA method 8
RAI_1_sample_IA_3.8<-RAI(agree_1_sample[,c(3,8)])
# Calculate RAI for IA method 3 vs IA method 9
RAI_1_sample_IA_3.9<-RAI(agree_1_sample[,c(3,9)])
# Calculate RAI for IA method 4 vs IA method 4
RAI_1_sample_IA_4.4<-RAI(agree_1_sample[,c(4,4)])
# Calculate RAI for IA method 4 vs IA method 5
RAI_1_sample_IA_4.5<-RAI(agree_1_sample[,c(4,5)])
# Calculate RAI for IA method 4 vs IA method 6
RAI_1_sample_IA_4.6<-RAI(agree_1_sample[,c(4,6)])
# Calculate RAI for IA method 4 vs IA method 7
RAI_1_sample_IA_4.7<-RAI(agree_1_sample[,c(4,7)])
# Calculate RAI for IA method 4 vs IA method 8
RAI_1_sample_IA_4.8<-RAI(agree_1_sample[,c(4,8)])
# Calculate RAI for IA method 4 vs IA method 9
RAI_1_sample_IA_4.9<-RAI(agree_1_sample[,c(4,9)])
# Calculate RAI for IA method 5 vs IA method 5
RAI_1_sample_IA_5.5<-RAI(agree_1_sample[,c(5,5)])
# Calculate RAI for IA method 5 vs IA method 6
RAI_1_sample_IA_5.6<-RAI(agree_1_sample[,c(5,6)])
# Calculate RAI for IA method 5 vs IA method 7
RAI_1_sample_IA_5.7<-RAI(agree_1_sample[,c(5,7)])
# Calculate RAI for IA method 5 vs IA method 8
RAI_1_sample_IA_5.8<-RAI(agree_1_sample[,c(5,8)])
# Calculate RAI for IA method 5 vs IA method 9
RAI_1_sample_IA_5.9<-RAI(agree_1_sample[,c(5,9)])
# Calculate RAI for IA method 6 vs IA method 6
RAI_1_sample_IA_6.6<-RAI(agree_1_sample[,c(6,6)])
# Calculate RAI for IA method 6 vs IA method 7
RAI_1_sample_IA_6.7<-RAI(agree_1_sample[,c(6,7)])
# Calculate RAI for IA method 6 vs IA method 8
RAI_1_sample_IA_6.8<-RAI(agree_1_sample[,c(6,8)])
# Calculate RAI for IA method 6 vs IA method 9
RAI_1_sample_IA_6.9<-RAI(agree_1_sample[,c(6,9)])
# Calculate RAI for IA method 7 vs IA method 7
RAI_1_sample_IA_7.7<-RAI(agree_1_sample[,c(7,7)])
# Calculate RAI for IA method 7 vs IA method 8
RAI_1_sample_IA_7.8<-RAI(agree_1_sample[,c(7,8)])
# Calculate RAI for IA method 7 vs IA method 9
RAI_1_sample_IA_7.9<-RAI(agree_1_sample[,c(7,9)])
# Calculate RAI for IA method 8 vs IA method 8
RAI_1_sample_IA_8.8<-RAI(agree_1_sample[,c(8,8)])
# Calculate RAI for IA method 8 vs IA method 9
RAI_1_sample_IA_8.9<-RAI(agree_1_sample[,c(8,9)])
# Calculate RAI for IA method 9 vs IA method 9
RAI_1_sample_IA_9.9<-RAI(agree_1_sample[,c(9,9)])
# Plot an heatmap of the overall agreement between different methods
overall_agreement_matrix <- matrix(NA, nrow=9, ncol=9)
for (i in 1:9) {
  for (j in 1:9) {
    RAI_result <- RAI(agree_1_sample[,c(i,j)])
    overall_agreement_matrix[i,j] <- RAI_result$Overall_agreement$value
  }
}
rownames(overall_agreement_matrix) <- c(1:9)
rownames(overall_agreement_matrix)[1:7] <- paste("IA", 1:7)
rownames(overall_agreement_matrix)[8:9] <- paste("Manual",1:2)
colnames(overall_agreement_matrix) <- c(1:9)
colnames(overall_agreement_matrix)[1:7] <- paste("IA", 1:7)
colnames(overall_agreement_matrix)[8:9] <- paste("Manual",1:2)
melted_overall_agreement <- melt(overall_agreement_matrix)
# Plot an heatmap of the overall agreement between different methods with numeric values on the tiles
ggplot(data = melted_overall_agreement, aes(x=Var1, y=Var2, fill=value)) +
  geom_tile(color = "white", linewidth = 0.5) +  # Adiciona bordas brancas
  geom_text(aes(label=round(value, 2)), color="black", size = 3.5) +
  scale_fill_gradient2(low = "#d73027", mid = "#ffffbf", high = "#1a9850", 
                       midpoint = 0.8,
                       name = "Agreement") +
  labs(title = "Overall Agreement between IA Methods", 
       x = "IA Method", y = "IA Method") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### To assess reliability: Kappa 

```{r}
lkappa(agree_1_IA[,c(1,2,3,4,5,6,7)])
lkappa(agree_1_sample[,c(1,2,3,4,5,6,7,8,9)])
lkappa(agree_1_sample_manual[,c(1,2)])
```

## Part 2: assess the inter-rater agreement and reliability among classifications

### To asssess the agreement: Proportions of overall and specific agreement 

```{r}
RAI_2_IA<-RAI(agree_2[,c(1,2,3)])
RAI_2<-RAI(agree_2[,c(1,2,3,4,5)])
RAI_2_manual<-RAI(agree_2[,c(4,5)])
cat("IA Overall agreement")
RAI_2_IA$Overall_agreement$value
cat("ALL Overall agreement")
RAI_2$Overall_agreement$value
cat("Manual Overall agreement")
RAI_2_manual$Overall_agreement$value
cat("IA Specific agreement")
RAI_2_IA$Specific_agreement$value
cat("ALL Specific agreement")
RAI_2$Specific_agreement$value
cat("Manual Specific agreement")
RAI_2_manual$Specific_agreement$value
```

If one IA method, selected at random, makes a classification (particular query present: yes or no), the probability of another method making an equal classification is 

If one IA method, selected at random, makes the classification yes (the particular query is present), the probability of another method making the same classification is 

If one IA method, selected at random, makes the classification no (the particular query is not present), the probability of another method making the same classification is 

### To asssess the agreement: Proportions of overall and specific agreement

```{r}
# Calculate RAI for IA method 1 vs IA method 1
RAI_1_sample_IA_1.1<-RAI(agree_1_sample[,c(1,1)])
# Calculate RAI for IA method 1 vs IA method 2
RAI_1_sample_IA_1.2<-RAI(agree_1_sample[,c(1,2)])
# Calculate RAI for IA method 1 vs IA method 3
RAI_1_sample_IA_1.3<-RAI(agree_1_sample[,c(1,3)])
# Calculate RAI for IA method 1 vs IA method 4
RAI_1_sample_IA_1.4<-RAI(agree_1_sample[,c(1,4)])
# Calculate RAI for IA method 1 vs IA method 5
RAI_1_sample_IA_1.5<-RAI(agree_1_sample[,c(1,5)])
# Calculate RAI for IA method 2 vs IA method 2
RAI_1_sample_IA_2.2<-RAI(agree_1_sample[,c(2,2)])
# Calculate RAI for IA method 2 vs IA method 3
RAI_1_sample_IA_2.3<-RAI(agree_1_sample[,c(2,3)])
# Calculate RAI for IA method 2 vs IA method 4
RAI_1_sample_IA_2.4<-RAI(agree_1_sample[,c(2,4)])
# Calculate RAI for IA method 2 vs IA method 5
RAI_1_sample_IA_2.5<-RAI(agree_1_sample[,c(2,5)])
# Calculate RAI for IA method 3 vs IA method 3
RAI_1_sample_IA_3.3<-RAI(agree_1_sample[,c(3,3)])
# Calculate RAI for IA method 3 vs IA method 4
RAI_1_sample_IA_3.4<-RAI(agree_1_sample[,c(3,4)])
# Calculate RAI for IA method 3 vs IA method 5
RAI_1_sample_IA_3.5<-RAI(agree_1_sample[,c(3,5)])
# Calculate RAI for IA method 4 vs IA method 4
RAI_1_sample_IA_4.4<-RAI(agree_1_sample[,c(4,4)])
# Calculate RAI for IA method 4 vs IA method 5
RAI_1_sample_IA_4.5<-RAI(agree_1_sample[,c(4,5)])
# Calculate RAI for IA method 5 vs IA method 5
RAI_1_sample_IA_5.5<-RAI(agree_1_sample[,c(5,5)])
# Plot an heatmap of the overall agreement between different methods
overall_agreement_matrix <- matrix(NA, nrow=5, ncol=5)
for (i in 1:5) {
  for (j in 1:5) {
    RAI_result <- RAI(agree_1_sample[,c(i,j)])
    overall_agreement_matrix[i,j] <- RAI_result$Overall_agreement$value
  }
}
rownames(overall_agreement_matrix) <- c(1:5)
rownames(overall_agreement_matrix)[1] <- "Gpt4o"
rownames(overall_agreement_matrix)[2] <- "Sonar pro"
rownames(overall_agreement_matrix)[3] <- "Gemini 2.5 pro"
rownames(overall_agreement_matrix)[4] <- "Marco"
rownames(overall_agreement_matrix)[5] <- "João"
colnames(overall_agreement_matrix) <- c(1:5)
colnames(overall_agreement_matrix)[1] <- "Gpt4o"
colnames(overall_agreement_matrix)[2] <- "Sonar pro"
colnames(overall_agreement_matrix)[3] <- "Gemini 2.5 pro"
colnames(overall_agreement_matrix)[4] <- "Marco"
colnames(overall_agreement_matrix)[5] <- "João"
melted_overall_agreement <- melt(overall_agreement_matrix)
# Plot an heatmap of the overall agreement between different methods with numeric values on the tiles
ggplot(data = melted_overall_agreement, aes(x=Var1, y=Var2, fill=value)) +
  geom_tile(color = "white", linewidth = 0.5) +  # Adiciona bordas brancas
  geom_text(aes(label=round(value, 2)), color="black", size = 3.5) +
  scale_fill_gradient2(low = "#d73027", mid = "#ffffbf", high = "#1a9850", 
                       midpoint = 0.8,
                       name = "Agreement") +
  labs(title = "Overall Agreement between IA Methods", 
       x = "IA Method", y = "IA Method") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### To assess reliability: Kappa 

```{r}
lkappa(agree_1_IA[,c(1,2,3,4,5,6,7)])
lkappa(agree_1_sample[,c(1,2,3,4,5,6,7,8,9)])
lkappa(agree_1_sample_manual[,c(1,2)])
```
